<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interaktiv f√∂rest√§llning</title>
  <style>
    body{font-family:system-ui,sans-serif;max-width:680px;margin:40px auto;padding:0 16px;background:#fafafa}
    #overlay{position:fixed;inset:0;background:black;color:white;display:flex;align-items:center;justify-content:center;z-index:10}
    #overlay button{font-size:22px;padding:16px 24px;border:0;border-radius:12px;cursor:pointer}
    #log{white-space:pre-wrap;margin-top:16px;font-size:16px;line-height:1.4}
  </style>
</head>
<body>
  <div id="overlay"><button id="startBtn">üé≠ Starta f√∂rest√§llningen</button></div>
  <h1>Interaktiv f√∂rest√§llning</h1>
  <div id="log"></div>
  <audio id="player" preload="auto"></audio>

  <script>
    const log = document.getElementById("log");
    const player = document.getElementById("player");
    const overlay = document.getElementById("overlay");
    const startBtn = document.getElementById("startBtn");
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec;
    const sessionId = crypto.randomUUID();

    const wait = ms => new Promise(r=>setTimeout(r,ms));
    const addLog = t => log.textContent += t + "\n";

    async function fetchScenes(){
      return await fetch("/scenes").then(r=>r.json());
    }

    function listenOnce(maxSeconds){
      return new Promise((resolve,reject)=>{
        if(!SR){reject(new Error("Taligenk√§nning saknas"));return;}
        rec = new SR();
        rec.lang="sv-SE";
        rec.interimResults=false;
        rec.maxAlternatives=1;
        let timer=setTimeout(()=>{rec.stop();reject(new Error("timeout"));}, maxSeconds*1000);
        rec.onresult=e=>{
          clearTimeout(timer);
          resolve(e.results[0][0].transcript);
        };
        rec.onerror=e=>reject(e);
        rec.start();
      });
    }

    async function aiExchange(opening,prompt,closing,maxSec){
      addLog("üé≠ AI: " + opening);
      // S√§g √∂ppningen via ElevenLabs
      const openingResp = await fetch("/web-act",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({text:opening,sessionId,prompt})
      });
      const openData = await openingResp.json();
      player.src=openData.audioUrl;
      await player.play(); await new Promise(r=>player.onended=r);

      addLog("üé§ Du: (lyssnar...)");
      let user = "(tystnad)";
      try { user = await listenOnce(maxSec); } catch {}
      addLog("Du: " + user);

      const replyResp = await fetch("/web-act",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({text:user,sessionId,prompt})
      });
      const data = await replyResp.json();
      addLog("AI: " + data.reply);
      player.src=data.audioUrl;
      await player.play(); await new Promise(r=>player.onended=r);

      if(closing){
        addLog("üé≠ Avslut: " + closing);
        const closeResp = await fetch("/web-act",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({text:closing,sessionId,prompt})
        });
        const closeData = await closeResp.json();
        player.src=closeData.audioUrl;
        await player.play(); await new Promise(r=>player.onended=r);
      }
    }

    async function playAudio(url){
      addLog("üéµ Spelar: " + url);
      player.src = url;
      await player.play(); await new Promise(r=>player.onended=r);
    }

    async function startShow(){
      overlay.style.display="none";
      const show = await fetchScenes();
      const personaPrompt = show.persona.systemPrompt;

      addLog("F√∂rest√§llningen startar ‚Ä¶");
      for(const act of show.acts){
        if(act.type==="audio") await playAudio(act.url);
        if(act.type==="ai"){
          await aiExchange(act.opening, personaPrompt, act.closing, act.maxTurnSeconds);
          await wait(500);
        }
      }
      addLog("üé¨ F√∂rest√§llningen √§r slut.");
    }

    startBtn.onclick=startShow;
  </script>
</body>
</html>


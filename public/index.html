<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interaktiv fÃ¶restÃ¤llning</title>
  <style>
    :root { color-scheme: light dark; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif;max-width:720px;margin:40px auto;padding:0 16px;background:#fafafa}
    h1{margin:0 0 8px 0}
    #overlay{position:fixed;inset:0;background:#000A;color:white;display:flex;align-items:center;justify-content:center;z-index:10}
    #overlay button{font-size:20px;padding:14px 22px;border:0;border-radius:12px;cursor:pointer}
    #log{white-space:pre-wrap;margin-top:16px;font-size:15px;line-height:1.45;background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px}
    .row{display:flex;gap:8px;align-items:center;margin:10px 0}
    #fallback{display:none}
    input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid #ccc}
    button.small{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
  </style>
</head>
<body>
  <div id="overlay"><button id="startBtn">ðŸŽ­ Starta fÃ¶restÃ¤llningen</button></div>
  <h1>Interaktiv fÃ¶restÃ¤llning</h1>
  <p>Musik â†’ dialog med AI â†’ musik â†’ â€¦ tills fÃ¶restÃ¤llningen Ã¤r slut.</p>

  <div id="fallback" class="row">
    <input id="fallbackInput" type="text" placeholder="Skriv ditt svar hÃ¤r om mikrofon inte funkarâ€¦" />
    <button id="fallbackSend" class="small">Skicka</button>
  </div>

  <div id="log"></div>

  <script type="module">
    import { ShowPlayer } from "./player.js";

    const logEl = document.getElementById("log");
    const overlay = document.getElementById("overlay");
    const startBtn = document.getElementById("startBtn");

    const fallbackBox = document.getElementById("fallback");
    const fallbackInput = document.getElementById("fallbackInput");
    const fallbackSend = document.getElementById("fallbackSend");

    const addLog = (t) => (logEl.textContent += t + "\n");
    const wait   = (ms) => new Promise(r => setTimeout(r, ms));

    // AnvÃ¤nd proxyn endast fÃ¶r externa mp3. /tts/* spelas direkt.
    const resolveAudio = (raw) => raw.startsWith("/tts/") ? raw : `/audio?u=${encodeURIComponent(raw)}`;

    // Web Speech API (Chrome/Edge bÃ¤st)
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

    // En unik session per besÃ¶k (servrarna minns kort historik)
    const sessionId = crypto.randomUUID();

    // Ljudspelare via WebAudio
    const showPlayer = new ShowPlayer();

    // ---- TaligenkÃ¤nning med timeout + fallback ----
    async function listenOnce(maxSeconds = 60) {
      // Fallback via textbox om SR saknas
      if (!SR) {
        fallbackBox.style.display = "flex";
        fallbackInput.value = "";
        fallbackInput.focus();
        return new Promise((resolve) => {
          const handler = () => {
            const v = (fallbackInput.value || "").trim();
            fallbackSend.removeEventListener("click", handler);
            resolve(v || "(tystnad)");
          };
          fallbackSend.addEventListener("click", handler);
        });
      }

      return new Promise((resolve) => {
        const recog = new SR();
        recog.lang = "sv-SE";
        recog.interimResults = false;
        recog.maxAlternatives = 1;

        let finished = false;
        const done = (text) => {
          if (finished) return;
          finished = true;
          try { recog.stop(); } catch {}
          resolve((text || "").trim() || "(tystnad)");
        };

        // Stoppa efter maxSeconds
        const timer = setTimeout(() => done("(tystnad)"), maxSeconds * 1000);

        recog.onresult = (e) => {
          clearTimeout(timer);
          const text = e.results?.[0]?.[0]?.transcript || "";
          done(text);
        };
        recog.onerror = () => {
          clearTimeout(timer);
          // Visa fallback direkt om anvÃ¤ndaren nekar mic
          fallbackBox.style.display = "flex";
          fallbackInput.value = "";
          fallbackInput.focus();
          // VÃ¤nta pÃ¥ manuell inmatning
          const handler = () => {
            const v = (fallbackInput.value || "").trim();
            fallbackSend.removeEventListener("click", handler);
            done(v || "(tystnad)");
          };
          fallbackSend.addEventListener("click", handler);
        };
        recog.onend = () => {
          // Om inget resultat kom â†’ timeout tar hand om det
        };

        try { recog.start(); } catch { done("(tystnad)"); }
      });
    }

    // ---- Ren TTS fÃ¶r manus (opening/closing) ----
    async function speakText(text) {
      const r = await fetch("/web-tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: String(text || "").slice(0, 4000) }),
      });
      if (!r.ok) throw new Error("web-tts HTTP " + r.status + " " + (await r.text()));
      const { audioUrl } = await r.json();
      await showPlayer.playUrl(resolveAudio(audioUrl));
    }

    // ---- AI-svar (publikens replik â†’ AI â†’ TTS) ----
    async function aiSpeak(userText, persona) {
      const r = await fetch("/web-act", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sessionId,
          text: String(userText || ""),
          prompt: String(persona || ""),
        }),
      });
      if (!r.ok) throw new Error("web-act HTTP " + r.status + " " + (await r.text()));
      const { reply, audioUrl } = await r.json();
      addLog("AI: " + reply);
      await showPlayer.playUrl(resolveAudio(audioUrl));
    }

    // ---- KÃ¶r hela fÃ¶restÃ¤llningen ----
    async function runShow() {
      try {
        overlay.style.display = "none";
        await showPlayer.resume(); // iOS/Chrome audio unlock

        // HÃ¤mta scener + persona frÃ¥n servern
        const scenesResp = await fetch("/scenes");
        if (!scenesResp.ok) throw new Error("Kunde inte hÃ¤mta scener");
        const scenes = await scenesResp.json();

        const persona =
          (scenes?.persona?.systemPrompt || "") +
          " Svara kort (1â€“2 meningar), tala vardagligt, ingen poesi.";

        // Loopa akter
        for (const act of scenes.acts || []) {
          if (act.type === "audio" && act.url) {
            addLog("ðŸŽµ Spelar: " + act.url);
            await showPlayer.playUrl(resolveAudio(act.url));
            continue;
          }

          if (act.type === "ai") {
            if (act.opening) {
              addLog("AI (manus): " + act.opening);
              await speakText(act.opening); // ðŸ”Š lÃ¤s manus, ingen modell
            }

            addLog("ðŸŽ¤ Du: (lyssnar upp till " + (act.maxTurnSeconds || 60) + " sekunder)");
            const userText = await listenOnce(act.maxTurnSeconds || 60);
            addLog("Du: " + userText);

            // AI svarar via modell + TTS
            await aiSpeak(userText, persona);

            if (act.closing) {
              addLog("AI (manus): " + act.closing);
              await speakText(act.closing); // ðŸ”Š lÃ¤s manus, ingen modell
            }
            continue;
          }
        }

        addLog("ðŸŽ¬ FÃ¶restÃ¤llningen Ã¤r slut.");
      } catch (e) {
        addLog("Show fel: " + e.message);
      }
    }

    // Startknapp
    startBtn.onclick = runShow;
  </script>
</body>
</html>
